<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat Application</title>
  <style>
     body {
        /* background: url("https://source.unsplash.com/900x2000/?macro"); */
        /* background-size: cover; */
padding: 0;
        margin: 0;
      }
      
      .message-body {
        height: 200px;
        width: 100%;
        overflow-x: hidden;
        overflow-y: scroll;
        scroll-behavior: smooth;
      }
      .footer {
        position: absolute;
        height: 60px;
        width: 100%;
        margin: auto;
        bottom: 0;
        right: 0;
        left: 0;
      }
      
     
      
  </style>
</head>
<body>
  <div class="header">Chat Application</div>
  <div class="message-body">
    <!-- <img src="https://flevix.com/wp-content/uploads/2019/07/Ring-Preloader.gif" class="loader" /> -->
  </div>
  <div class="footer">
    <center>
      <input type="text" placeholder="Enter message" class="message-input" />
      <button class="send-button">Send</button>
    </center>
  </div>

  <script src="https://www.gstatic.com/firebasejs/7.14.5/firebase.js"></script>
  <script>
    // Firebase configuration
    var firebaseConfig = {
      apiKey: "AIzaSyDLtWbefGSAd8ACZxnHJxF7wLgrkXEvkEs",
      authDomain: "chat-app-d9289.firebaseapp.com",
      databaseURL: "https://chat-app-d9289-default-rtdb.firebaseio.com",
      projectId: "chat-app-d9289",
      storageBucket: "chat-app-d9289.appspot.com",
      messagingSenderId: "910151259608",
      appId: "1:910151259608:web:b752216bbef028090f8ead",
      measurementId: "G-EKHNKSYT0J",
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    var me = "";
    var receiverEmail = "";

    window.onload = function () {
      window.addEventListener("message", async function (event) {
        try {
          console.log("Received data from Thunkable:", event.data);
          const data = event.data;

          // Parse data if it is a JSON string
          if (typeof data === 'string') {
            const parsedData = JSON.parse(data);

            me = parsedData.senderEmail;
            receiverEmail = parsedData.receiverEmail;

            if (me && receiverEmail) {
              const messageInput = document.querySelector(".message-input");
              const sendButton = document.querySelector(".send-button");

              const sendMessage = () => {
                const message = messageInput.value.trim();
                if (message) {
                  firebase
                    .database()
                    .ref(`chats/${me}_${receiverEmail}/Texts`)
                    .push({
                      user: me,
                      msg: message.replace(/</g, "&lt;"),
                    });
                  messageInput.value = "";
                }
              };

              messageInput.addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                  sendMessage();
                }
              });

              sendButton.addEventListener("click", () => {
                sendMessage();
              });
            var id = "";
          firebase
            .database()
            .ref(`chats/${senderEmail}_${receiverEmail}/Texts`)
            .on("child_added", (s) => {
              document.querySelector(".loader").style.opacity = "0";
            // document.querySelector(".loader").style.display = "none";
              if (s.val().user === me) {
                if (id !== s.val().user)
                  document.querySelector(".message-body").innerHTML +=
                    '<div class="my-name">You</div><div class="message-holder"><div class="my-text" onclick="deleteMsg(\'' +
                    s.key +
                    "')\" id=" +
                    s.key +
                    " >" +
                    s.val().msg +
                    "</div></div>";
                else
                  document.querySelector(".message-body").innerHTML +=
                    '<div class="message-holder"><div class="my-text" onclick="deleteMsg(\'' +
                    s.key +
                    "')\" id=" +
                    s.key +
                    ">" +
                    s.val().msg +
                    "</div></div>";
              } else {
                if (id !== s.val().user)
                  document.querySelector(".message-body").innerHTML +=
                    '<div class="their-name">' +
                    s.val().user +
                    '</div><div class="message-holder"><div class="their-text" id=' +
                    s.key +
                    ">" +
                    s.val().msg +
                    "</div></div>";
                else
                  document.querySelector(".message-body").innerHTML +=
                    '<div class="message-holder"><div class="their-text" id=' +
                    s.key +
                    ">" +
                    s.val().msg +
                    "</div></div>";
              }
              document.querySelector(".message-body").scrollBy(0, 1000);
              id = s.val().user;
              firebase
                .database()
                .ref(`chats/${senderEmail}_${receiverEmail}/Texts/` + s.key)
                .on("child_changed", (a) => {
                  document.querySelector("#" + s.key).innerHTML =
                    "<i>Message Erased</i>";
                });
            });
            } else {
              console.error("Sender or receiver email missing.");
            }
          } else {
            console.error("Unexpected data format:", data);
          }
        } catch (error) {
          console.error("Error parsing the data from Thunkable:", error);
        }
      });
    };
  </script>
</body>
</html>
